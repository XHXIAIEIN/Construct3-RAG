# Construct 3 RAG 助手 - 系统架构设计

## 概述

基于 Construct 3 资料（Markdown 手册、i18n 翻译词条、示例项目），构建一个综合助手系统。

**部署环境：** 本地电脑（有 GPU）
**优先功能：** 文档问答 → 翻译辅助 → 事件表生成

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  Gradio Web  │  │  FastAPI     │  │  C3 Editor Plugin    │   │
│  │  聊天界面     │  │  REST API    │  │  (未来)              │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         应用逻辑层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ Query Router │  │ Prompt       │  │  Response Parser     │   │
│  │ 意图识别      │  │ Builder      │  │  结果解析            │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         RAG 引擎层                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    LangChain Framework                      │ │
│  ├──────────────┬──────────────┬──────────────────────────────┤ │
│  │ Hybrid       │ Reranker     │  Context Compressor          │ │
│  │ Retriever    │ BGE-reranker │  上下文压缩                   │ │
│  └──────────────┴──────────────┴──────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         向量存储层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ c3_manual    │  │ c3_terms     │  │  c3_examples         │   │
│  │ 手册向量      │  │ 术语表索引    │  │  示例代码向量         │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│                        Qdrant Vector Database                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          LLM 层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ Qwen2.5-14B  │  │ DeepSeek     │  │  Backup: API         │   │
│  │ 主推理模型    │  │ 代码生成      │  │  复杂推理            │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│                      Ollama / vLLM Runtime                       │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. 向量数据库 Collections

| Collection | 用途 | 数据来源 | 索引类型 |
|------------|------|----------|----------|
| `c3_manual` | 手册文档检索 | Markdown 手册 | 向量 |
| `c3_terms` | 术语翻译查询 | CSV 翻译词条 | 向量 + BM25 |
| `c3_examples` | 代码示例检索 | 示例项目 | 向量 |

### 2. 检索策略

```
用户查询
    │
    ▼
┌─────────────┐
│ 意图识别     │ ─── 判断查询类型（问答/翻译/代码）
└─────────────┘
    │
    ├── 问答类 ──────────────────┐
    │                           ▼
    │                    c3_manual 向量检索
    │                           │
    ├── 翻译类 ──────────────────┤
    │                           ▼
    │                    c3_terms BM25 精确匹配
    │                           + 向量语义匹配
    │                           │
    └── 代码类 ──────────────────┤
                                ▼
                         c3_examples 向量检索
                                │
                                ▼
                         ┌─────────────┐
                         │ Reranker    │
                         │ 重排序       │
                         └─────────────┘
                                │
                                ▼
                         ┌─────────────┐
                         │ LLM 生成    │
                         └─────────────┘
```

## 技术选型

| 组件 | 选择 | 理由 |
|------|------|------|
| **LLM** | Qwen2.5-14B-AWQ | 中英双语、本地运行、4-bit 量化节省显存 |
| **向量库** | Qdrant | Rust 高性能、易部署、支持混合检索 |
| **Embedding** | BAAI/bge-m3 | 多语言、支持稀疏+稠密混合 |
| **框架** | LangChain | 生态完善、文档丰富 |
| **推理引擎** | Ollama | 简单易用、开箱即用 |
| **前端** | Gradio | 快速原型、Python 原生 |

## 硬件需求

| 配置项 | 推荐规格 |
|--------|----------|
| GPU | RTX 3090/4090 24GB |
| RAM | 32GB+ |
| 存储 | 50GB+ |
| VRAM 占用 | ~8GB (4-bit 量化模型) |
